<!-- Amply Motion Code -->
<script src="https://joinamply.github.io/amply-motion/dist/index.js"></script>
<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<!-- Plyr.io -->
<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

<!-- Navbar -->
<script>
    ScrollTrigger.create({
        trigger: ".page-wrapper",
        start: "top+=75 top",
        end: "+=0",
        onEnter: () => $(".navbar_layout").addClass("is-scrolling"),
        onEnterBack: () => $(".navbar_layout").removeClass("is-scrolling"),
    });
</script>

<!-- Footer Copywrite Year -->
<script>
    $('[copyright-year]').text(new Date().getFullYear());
</script>

<!-- Hide if collections is empty -->
<script>
    $('.w-dyn-empty').parents('[hide-if-empty]').each(function () { $(this).hide() });
</script>

<!-- Keep form height on success -->
<script>
    $(window).bind("load resize submit", function (e) {
        $('form').each(function () {
            var formHeight = $(this).height();
            $(this).siblings('.w-form-done').css({ 'min-height': formHeight });
        });
    });
</script>

<!-- HubSpot API -->
<script>
    let hsApiUrl = 'https://api.hsforms.com/submissions/v3/integration/submit/PORTAL-ID/';
    let formData = {
        fields: [],
    };
    let UTMs = ['utm_medium', 'utm_source', 'utm_campaign', 'utm_term', 'utm_content'];

    $('[hs-form]').on('submit', function (event) {
        let hsForm = $(this);
        let hsFormID = $(this).attr('hs-form');
        if (hsFormID == undefined) return;
        let hsEndPoint = hsApiUrl + hsFormID;
        let redirectURL = $(this).attr('redirect-url');
        // Add the form data to the formData object
        hsForm.find('[hs-form-field]').each(function () {
            let field = {
                name: $(this).attr('hs-form-field'),
                value: $(this).val(),
            };
            formData.fields.push(field);
        });
        // Add the UTM parameters to the formData object
        UTMs.forEach(utm => {
            let utmValue = new URLSearchParams(window.location.search).get(utm);
            if (utmValue != null) {
                let field = {
                    name: `${utm}`,
                    value: utmValue,
                };
                formData.fields.push(field);
            }
        });
        console.log('HubSpot Form Data:', formData);
        // Get page information
        let pageName = document.title; // Use the page title as the name
        let pageUrl = window.location.href; // Get the full URL of the page
        let hubspotCookie = document.cookie.match(/(?:^|;\s*)hubspotutk\s*=\s*([^;]*)/);
        let htuk = hubspotCookie ? hubspotCookie[1] : null;
        // Create the hs_context object
        if (htuk) {
            formData.context = {
                hutk: htuk,
                pageUri: pageUrl,
                pageName: pageName,
            };
        }
        // Make a POST request to HubSpot
        fetch(hsEndPoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        })
            .then(response => response.json())
            .then(data => {
                console.log('HubSpot Form Submission Successful:', data);

                const { redirectUri } = data;

                if (redirectURL != undefined) {
                    setTimeout(() => {
                        window.location = redirectURL;
                    }, 1000);
                } else if (redirectUri != undefined) {
                    setTimeout(() => {
                        window.location = redirectUri;
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('HubSpot Form Submission Error:', error);
                // Handle error, e.g., show an error message to the user
            });
    });
</script>

<!-- Thumbail Players -->
<script>
    let thumbPlayers = Plyr.setup((".plyr_thumb"), {
        controls: [],
        blankVideo: "https://cdn.plyr.io/static/blank.mp4",
        resetOnEnd: true
    });

    $('.thumb-plyr_wrap').each(function (index) {
        // Add an attribute with the index value
        $(this).attr('thumb-plyr', `${index}`);
        // Stop by default
        $(thumbPlayers[index])[0].stop();
    });

    function playThumbPlyr(plyrWrap, index) {        
        let thumbPlayer = $(thumbPlayers[index])[0];
        thumbPlayer.volume = 0;
        thumbPlayer.muted = true;
        thumbPlayer.loop = true;
        let promise = thumbPlayer.play();

        if(gsap.isTweening(plyrWrap)) {
            gsap.killTweensOf(plyrWrap);
        }
        gsap.to(plyrWrap, { opacity: 1, duration: 0.3 });

        if (promise !== undefined) {
            promise.catch(error => {
                console.log("Thumb Auto-play was prevented");
            }).then(() => {
                console.log("Thumb Auto-play started");
            });
        }
        thumbPlayer.play();
    }

    function stopThumbPlyr(plyrWrap, index) {
        if(gsap.isTweening(plyrWrap)) {
            gsap.killTweensOf(plyrWrap);
        }
        gsap.to(plyrWrap, { opacity: 0, duration: 0.3, onComplete: () => {
            $(thumbPlayers[index])[0].stop();
        } });
    }


    // $('.video-slide_layout').on('mouseenter', function () {
    //     $(this).find('.thumb-plyr_wrap').css('opacity', '1');
    //     let thumbPlyrIndex = $(this).find('.thumb-plyr_wrap').attr('thumb-plyr');
    //     playThumbPlyr(thumbPlyrIndex);
    // });

    // $('.video-slide_layout').on('mouseleave', function () {
    //     $(this).find('.thumb-plyr_wrap').css('opacity', '0');
    //     let thumbPlyrIndex = $(this).find('.thumb-plyr_wrap').attr('thumb-plyr');
    //     stopThumbPlyr(thumbPlyrIndex);
    // });
</script>

<!-- Swiper Slider -->
<script>
    $(".swiper_component").each(function () {
        let slidesPerView = $(this).attr("slides-per-view") !== undefined ? $(this).attr("slides-per-view") : "auto";
        if (slidesPerView != "auto") {
            slidesPerView = parseFloat(slidesPerView);
        }
        let followFinger = $(this).attr("follow-finger") !== undefined ? $(this).attr("follow-finger") === "true" : false;
        let speed = $(this).attr("speed") !== undefined ? parseInt($(this).attr("speed")) : 500;
        let autoHeight = $(this).attr("auto-height") !== undefined ? $(this).attr("auto-height") === "true" : false;
        let effect = $(this).attr("effect") !== undefined ? $(this).attr("effect") : "slide"; // slide, fade, flip, coverflow, cards, cube
        let loop = $(this).attr("set-loop") !== undefined ? $(this).attr("set-loop") === "true" : false;
        let loopAdditionalSlides = $(this).attr("loop-additional-slides") !== undefined ? parseInt($(this).attr("loop-additional-slides")) : 0;
        let centeredSlides = $(this).attr("centered-slides") !== undefined ? $(this).attr("centered-slides") === "true" : false;
        const swiper = new Swiper($(this).find(".swiper")[0], {
            effect: effect,
            // fadeEffect: {
            //     crossFade: true
            // },
            // flipEffect: {
            //     slideShadows: false,
            // },
            // coverflowEffect: {
            //     rotate: 30,
            //     slideShadows: false,
            // },
            // cardsEffect: {
            //     // ...
            // },
            // cubeEffect: {
            //     slideShadows: false,
            // },
            slidesPerView: slidesPerView,
            followFinger: followFinger,
            speed: speed,
            autoHeight: autoHeight,
            a11y: true,
            loop: loop,
            loopAdditionalSlides: loopAdditionalSlides,
            centeredSlides: centeredSlides,
            loopAddBlankSlides: true,
            pagination: {
                el: $(this).find(".swiper_bullets-wrapper")[0],
                bulletActiveClass: "is-active",
                bulletClass: "swiper_bullet",
                bulletElement: "button",
                clickable: true
            },
            navigation: {
                nextEl: $(this).find('[swiper-button="next"]')[0],
                prevEl: $(this).find('[swiper-button="prev"]')[0],
                disabledClass: "is-disabled"
            }
        });

        // Make sure the previous slide is visible when the loop is enabled
        if (loop) {
            swiper.slidePrev();
            swiper.slideToLoop(0, 0);
        }

        // Get the current slide and play the thumb video if it has one
        let currentSlide = swiper.slides[swiper.activeIndex];
        $(currentSlide).find('.thumb-plyr_wrap').each(function () {
            ScrollTrigger.create({
                trigger: $(this),
                start: "top bottom",
                end: "+=0",
                onEnter: () => {
                    let thumbPlyrIndex = $(this).attr('thumb-plyr');
                    playThumbPlyr($(this), thumbPlyrIndex);
                },
            });
        });

        swiper.on('slideChange', function () {
            let currentSlide = swiper.slides[swiper.activeIndex];
            let previousSlide = swiper.slides[swiper.previousIndex];

            // Stop previous slide
            $(previousSlide).find('.thumb-plyr_wrap').each(function () {
                let thumbPlyrIndex = $(this).attr('thumb-plyr');
                stopThumbPlyr($(this), thumbPlyrIndex);
            });

            // Play current slide
            $(currentSlide).find('.thumb-plyr_wrap').each(function () {
                let thumbPlyrIndex = $(this).attr('thumb-plyr');
                playThumbPlyr($(this), thumbPlyrIndex);
            });
        });
    });

    // Change all slides roles to prevent an accessibility issue
    $(".swiper-slide").attr("role", "listitem");
</script>